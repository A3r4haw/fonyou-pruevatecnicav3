<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"    
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui" >

    <h:body>
        <ui:composition template="../template/mainLayout.xhtml">
            <ui:define name="content">
                <div class="mainPanelAmplio" >
                    <h:form id="mainForm">
                        <p:focus context="mainForm"/>

                        <div id="busqueda" style="height: 30px !important;">
                            <p:outputLabel value="Recetas"  style="color: #FFFFFF;font-size: 18px !important;font-weight: bold;margin-right: 50px;" />
                            <ui:remove>
                                <p:selectCheckboxMenu id="menu" value="#{servicioSurtPrescripcionExtMB.tipoPrescripcionSelectedList}" label="Tipo"
                                                  filter="true" filterMatchMode="startsWith" panelStyle="width:110px" style="width: 110px;">
                              
                                <f:selectItem value="#{N}" itemLabel="Normal" itemValue="N" />
                                <f:selectItem value="#{U}" itemLabel="Urgente" itemValue="U" />
                                <f:selectItem value="#{D}" itemLabel="Dosis Única" itemValue="D" />
                            </p:selectCheckboxMenu>
                            </ui:remove>
                            <p:spacer width="10px;" />
                            <p:inputText id="busquedaa" 
                                         value="#{servicioSurtPrescripcionExtMB.cadenaBusqueda}" 
                                         class="textSearch"
                                         style="width: 50% !important;" 
                                         placeholder="Buscar..." />
                            <i class="fa fa-search" aria-hidden="true" style="position:absolute;  text-indent: 5px; margin-top: 3px; margin-left: -25px; color: #AAAAAA; font-size: 0.9em;" />
                            <p:spacer width="12px" />
                            <p:commandButton title="Buscar" value="Buscar" icon="ui-icon-search" 
                                             onclick="PF('statusProcess').show();"
                                             oncomplete="PF('statusProcess').hide(); if(args.modal){PF('modalSurtimiento').show(); }"
                                             actionListener="#{servicioSurtPrescripcionExtMB.obtenerSurtimientos}"
                                             update=":mainForm,:formSurtimientoDetail"  />
                            
                            <p:commandButton title="Buscar" value="Buscar WS" icon="ui-icon-search" 
                                             onclick="PF('statusProcess').show();"                                             
                                             rendered="#{servicioSurtPrescripcionExtMB.permiso.puedeVer}"
                                             oncomplete="PF('statusProcess').hide(); if(args.modal){PF('modalSurtimiento').show(); }"
                                             actionListener="#{servicioSurtPrescripcionExtMB.obtenerRecetaSiamWS}"
                                             update=":mainForm,:formSurtimientoDetail,formSurtimientoDetail:tblInsumos"  />
                            
                        </div>

                        <p:toolbar rendered="false">
                            <p:toolbarGroup id="toolbar"  >
                                <p:commandButton id="btnModificar" value="Modificar"
                                                 title="Modificar Rol" icon="ui-icon-pencil"
                                                 onclick="PF('statusProcess').show()"
                                                 oncomplete="PF('statusProcess').hide(); PF('modalSurtimiento').show();"

                                                 update=":formSurtimientoDetail"
                                                 disabled="#{!servicioSurtPrescripcionExtMB.permiso.puedeEditar or !servicioSurtPrescripcionExtMB.elementoSeleccionado}"
                                                 rendered="false" />

                                <p:commandButton id="btnCancelar" value="Cancelar"
                                                 title="Cancelar Surtimiento Prescripción" icon="ui-icon-trash" 
                                                 update="@form"
                                                 disabled="#{!servicioSurtPrescripcionExtMB.permiso.puedeEliminar or !servicioSurtPrescripcionExtMB.elementoSeleccionado}"
                                                 rendered="false" />

                            </p:toolbarGroup>
                        </p:toolbar>

                        <p:messages id="validaMsg" globalOnly="true" showSummary="true" closable="true" showDetail="true" >
                            <p:autoUpdate />
                        </p:messages>
                        
                        <p:tabView>
                            <p:ajax 
                                event="tabChange" 
                                    process="@this" 
                                    update="mainForm:tblSurtimientos"
                                    listener="#{servicioSurtPrescripcionExtMB.onTabChange}"/>                            
                            <p:tab title="PROGRAMADAS" id="#{servicioSurtPrescripcionExtMB.programada}" >                                
                            </p:tab>
                            <p:tab title="SURTIDAS" id="#{servicioSurtPrescripcionExtMB.surtida}" >                                
                            </p:tab>                            
                            <p:tab title="CANCELADAS" id="#{servicioSurtPrescripcionExtMB.cancelada}" >                                
                            </p:tab>                            
                        </p:tabView>
                        
                        <p:panel id="dataTable">
                            <p:dataTable id="tblSurtimientos" 
                                         widgetVar="tblSurtimientos" 
                                         value="#{servicioSurtPrescripcionExtMB.servSurtPrescripcionExtLazy}"
                                         selection="#{servicioSurtPrescripcionExtMB.surtimientoExtendedSelected}"
                                         lazy="true"
                                         var="item" 
                                         rowKey="#{item.idSurtimiento}"
                                         rowIndexVar="row"
                                         selectionMode="single"
                                         style="margin-bottom:5px;"
                                         styleClass="mystyle"
                                         scrollRows="10" scrollable="true" scrollHeight="350"
                                         emptyMessage="No se encontraron Registros"
                                         reflow="true"
                                         paginatorTemplate="{Records} {CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {Exporters}"
                                         currentPageReportTemplate=" "
                                         paginator="true"
                                         rows="10"
                                         disabledTextSelection="false" 
                                         paginatorPosition="bottom"
                                         rendered="#{servicioSurtPrescripcionExtMB.sizeSurtimientoExtendList ne 100}"
                                         rowStyleClass="#{item.tipoPrescripcion eq 'U' ? 'urgente' : item.tipoPrescripcion eq 'D' ? 'unica': null}" >

                                <p:ajax event="rowUnselect" listener="#{servicioSurtPrescripcionExtMB.onRowUnselectSurtimiento}" update=":mainForm:btnModificar  "  />
                                <p:ajax event="rowSelect" listener="#{servicioSurtPrescripcionExtMB.onRowSelectSurtimiento}" update=":mainForm:btnModificar " />
                                <p:ajax event="rowDblselect" listener="#{servicioSurtPrescripcionExtMB.verSurtimiento}" update=":formSurtimientoDetail"
                                        onstart="PF('statusProcess').show()"
                                        oncomplete="PF('statusProcess').hide(); PF('modalSurtimiento').show();" />

                                <f:facet name="{Records}">
                                    <div style="float:left;">
                                        <!--<p:outputLabel class="footerLabel" value="  Prescripciones Programadas: #{servicioSurtPrescripcionExtMB.sizeSurtimientoExtendList}" rendered="true" />-->
                                    </div>
                                </f:facet>

                                <f:facet name="{Exporters}">
                                    <div style="float:right">
                                        <h:commandLink >
                                            <img src="#{request.contextPath}/resources/img/btnxls.png" style="height: 25px !important; margin-left: 5px !important;" title="Exportar" />
                                            <p:dataExporter type="xls" target="tblSurtimientos" fileName="pacientes" />
                                        </h:commandLink>
                                        <h:commandLink>
                                            <img src="#{request.contextPath}/resources/img/btnpdf.png" style="height: 25px !important; margin-left: 5px !important;" title="Exportar" />
                                            <p:dataExporter type="pdf" target="tblSurtimientos" fileName="pacientes"/>
                                        </h:commandLink>
                                    </div>
                                </f:facet>

                                <p:column style="text-align: left; width: 1% "
                                          sortBy="#{item.tipoPrescripcion}" exportable="false" >
                                    <f:facet name="header" >
                                        <h:outputText value="" />
                                    </f:facet>
                                    <p:outputPanel rendered="#{item.tipoPrescripcion eq 'N'}" >
                                        <img src="#{request.contextPath}/resources/img/cpnormal.png" style="height: 15px !important; margin-left: 0px !important;" />
                                    </p:outputPanel>
                                    <p:outputPanel rendered="#{item.tipoPrescripcion eq 'U'}" >
                                        <img src="#{request.contextPath}/resources/img/cpurgente.png" style="height: 15px !important; margin-left: 0px !important;" />
                                    </p:outputPanel>
                                    <p:outputPanel rendered="#{item.tipoPrescripcion eq 'D'}" >
                                        <img src="#{request.contextPath}/resources/img/cpunica.png" style="height: 15px !important; margin-left: 0px !important;" />
                                    </p:outputPanel>
                                </p:column>

                                <p:column style="text-align: left; width: 10% "
                                          sortBy="#{item.fechaProgramada}" >
                                    <f:facet name="header" >
                                        <h:outputText value="Folio Receta" />
                                    </f:facet>
                                    <h:outputText value="#{item.folioPrescripcion}" />
                                </p:column>

                                <p:column style="text-align: left; width: 10% "
                                          sortBy="#{item.fechaProgramada}" >
                                    <f:facet name="header" >
                                        <h:outputText value="Fecha" />
                                    </f:facet>
                                    <h:outputText value="#{item.fechaProgramada}" >
                                        <f:convertDateTime pattern="yyyy-MM-dd HH:mm" />
                                    </h:outputText>
                                </p:column>                                

                                <p:column style="text-align: left; width: 20% "
                                          sortBy="#{item.nombrePaciente}" >
                                    <f:facet name="header" >
                                        <h:outputText value="Paciente" />
                                    </f:facet>
                                    <h:outputText value="#{item.nombrePaciente}" />
                                </p:column>

                                <p:column style="text-align: left; width: 20% " 
                                          sortBy="#{item.nombreEstructura}" >
                                    <f:facet name="header" >
                                        <h:outputText value="Ubicación" />
                                    </f:facet>
                                    <h:outputText value="#{item.nombreEstructura}" />
                                </p:column>

                                <ui:remove>
                                <p:column style="text-align: left; width: 5% "
                                          sortBy="#{item.cama}" >
                                    <f:facet name="header" >
                                        <h:outputText value="Cama" />
                                    </f:facet>
                                    <h:outputText value="#{item.cama}" />
                                </p:column>
                                </ui:remove>

                                <p:column style="text-align: left; width: 20% " 
                                          sortBy="#{item.nombreMedico}" >
                                    <f:facet name="header" >
                                        <h:outputText value="Médico" />
                                    </f:facet>
                                    <h:outputText value="#{item.nombreMedico}" />
                                </p:column>

                            </p:dataTable>

                            
                        </p:panel>

                    </h:form>
                </div>


                <p:dialog header="SURTIMIENTO DE RECETA"
                          widgetVar="modalSurtimiento"
                          closeOnEscape="true"
                          closable="true"
                          modal="true" 
                          width="85%"
                          resizable="false"
                          responsive="true"
                          style="font-size:xx-small !important; " >

                    <h:form id="formSurtimientoDetail" >
                        <p:focus context="formSurtimientoDetail:autoSkuSap"/>
                        <p:messages id="msgValidaRegistro" globalOnly="false" showDetail="false" closable="true" />

                        <div class="ui-g" >
                            <div class="ui-g-12" >
                                <div class="ui-g-12 ui-md-6 ui-lg-2">
                                    <p:outputLabel style="margin-right: 10px;">Folio Receta:</p:outputLabel>
                                    <br/>
                                    <p:outputLabel style="margin-right: 10px;" value="#{servicioSurtPrescripcionExtMB.surtimientoExtendedSelected.folioPrescripcion}"
                                                   class="textoNegrita lbl-subtitulo" />
                                    <p:outputLabel class="lbl-Tipo-PrescripcionNormal" value="Normal" rendered="#{servicioSurtPrescripcionExtMB.surtimientoExtendedSelected.tipoPrescripcion eq 'N'}" />
                                    <p:outputLabel class="lbl-Tipo-PrescripcionUnica" value="Única" rendered="#{servicioSurtPrescripcionExtMB.surtimientoExtendedSelected.tipoPrescripcion eq 'D'}" />
                                    <p:outputLabel class="lbl-Tipo-PrescripcionUrgente" value="Urgente" rendered="#{servicioSurtPrescripcionExtMB.surtimientoExtendedSelected.tipoPrescripcion eq 'U'}" />
                                </div>
                                <div class="ui-g-12 ui-md-6 ui-lg-2">
                                    <p:outputLabel style="margin-right: 10px;">Folio Surtimiento:</p:outputLabel>
                                    <br/>
                                    <p:outputLabel style="margin-right: 10px;" value="#{servicioSurtPrescripcionExtMB.surtimientoExtendedSelected.folio}" class="textoNegrita lbl-subtitulo" />
                                </div>
                                <div class="ui-g-12 ui-md-6 ui-lg-2">
                                    <p:outputLabel style="margin-right: 10px;">Fecha Programada:</p:outputLabel>
                                    <br/>
                                    <p:outputLabel style="margin-right: 10px;" value="#{servicioSurtPrescripcionExtMB.surtimientoExtendedSelected.fechaProgramada}"  class="textoNegrita lbl-subtitulo">
                                        <f:convertDateTime type="date" pattern="dd/MM/yyyy" />
                                    </p:outputLabel>
                                </div>
                                
                                <div class="ui-g-12 ui-md-6 ui-lg-2">
                                    <p:outputLabel style="margin-right: 10px;">Resurtimientos Maximos:</p:outputLabel>
                                    <br/>
                                    <p:outputLabel style="margin-left: 25%; text-align: center" value="#{servicioSurtPrescripcionExtMB.cantResurt}" class="textoNegrita lbl-subtitulo"/>
                                </div>
                                <div class="ui-g-12 ui-md-6 ui-lg-2">
                                    <p:outputLabel style="margin-right: 10px;">Actual Resurtimiento:</p:outputLabel>
                                    <br/>
                                    <p:outputLabel style="margin-left: 25%; text-align: center" value="#{servicioSurtPrescripcionExtMB.numResurtimiento}" class="textoNegrita lbl-subtitulo"/>
                                </div>
                                <div class="ui-g-12 ui-md-6 ui-lg-2">
                                    <p:outputLabel style="margin-right: 10px;">Estatus Surtimiento:</p:outputLabel>
                                    <br/>
                                    <p:outputLabel style="margin-right: 10px;" value="#{servicioSurtPrescripcionExtMB.surtimientoExtendedSelected.estatusPrescripcion}" class="textoNegrita lbl-subtitulo"/>
                                </div>
                            </div>
                        </div>
                        <div class="ui-g panelGris" >
                            <div class="ui-g-12" >
                                <div class="ui-g-12 ui-md-6 ui-lg-2">
                                    <p:outputLabel style="margin-right: 10px;" value="Servicio:" />
                                    <br/>
                                    <p:outputLabel style="margin-right: 10px;" class="textoNegrita" value="#{servicioSurtPrescripcionExtMB.surtimientoExtendedSelected.nombreEstructura}" />
                                </div>
                                <ui:remove>
                                <div class="ui-g-12 ui-md-6 ui-lg-2">
                                    <i class="fa fa-bed" aria-hidden="true" />
                                    <br/>
                                    <p:outputLabel style="margin-right: 10px;" value="#{servicioSurtPrescripcionExtMB.surtimientoExtendedSelected.cama}" />
                                </div>
                                </ui:remove>
                                <div class="ui-g-12 ui-md-6 ui-lg-2">
                                    <p:outputLabel style="margin-right: 10px;" value="Paciente: "/>
                                    <br/>
                                    <p:outputLabel style="margin-right: 10px;" class="textoNegrita" value="#{servicioSurtPrescripcionExtMB.surtimientoExtendedSelected.nombrePaciente}" />
                                </div>
                                <div class="ui-g-12 ui-md-6 ui-lg-2">
                                    <p:outputLabel style="margin-right: 10px;" value="No. Paciente:" />
                                    <br/>
                                    <p:outputLabel style="margin-right: 10px;" class="textoNegrita" value="#{servicioSurtPrescripcionExtMB.surtimientoExtendedSelected.pacienteNumero}" />
                                </div>
                                <div class="ui-g-12 ui-md-6 ui-lg-2">
                                    <p:outputLabel style="margin-right: 10px;" value="Médico:" />
                                    <br/>
                                    <p:outputLabel style="margin-right: 10px;" class="textoNegrita" value="#{servicioSurtPrescripcionExtMB.surtimientoExtendedSelected.nombreMedico}" />
                                </div>
                                <div class="ui-g-12 ui-md-6 ui-lg-2">
                                    <p:outputLabel style="margin-right: 10px;">Pepmae:</p:outputLabel>
                                    <br/>
                                    <p:outputLabel style="margin-left: 15px" rendered="#{servicioSurtPrescripcionExtMB.existePacientePepmae}" ><i class="fa fa-check-circle iconMusVerde" /></p:outputLabel>
                                    <p:outputLabel style="margin-left: 15px" rendered="#{!servicioSurtPrescripcionExtMB.existePacientePepmae}"><i class="fa fa-times-circle iconMusRojo" /></p:outputLabel> 
                                </div>
                            </div>
                        </div>
                        
                        <div class="ui-g">
                            <div class="ui-g-12">
                                <div class="ui-g-12 ui-md-6 ui-lg-1">
                                    <p:selectBooleanCheckbox id="txtEliminar" value="#{servicioSurtPrescripcionExtMB.eliminaCodigoBarras}" 
                                                             itemLabel="Eliminar" />
                                </div>
                                <div class="ui-g-12 ui-md-6 ui-lg-1">
                                    <p:inputText id="xcantidad" 
                                                 value="#{servicioSurtPrescripcionExtMB.xcantidad}"
                                                 onkeypress="if (event.keyCode === 13) { agregaEnviado(); return false; } " 
                                                 size="5">
                                        <p:keyFilter regEx="/[0-9]{1,4}/i" />
                                    </p:inputText>
                                </div>
                                <div class="ui-g-12 ui-md-6 ui-lg-3">
                                    <!--TODO: Se agrega Autocomplete para encontrar un medicamento -->
                                    <p:autoComplete id="autoSkuSap"
                                                    styleClass="focusme"
                                                    disabled="#{!servicioSurtPrescripcionExtMB.procederSurtimiento or !servicioSurtPrescripcionExtMB.puedeSurtirPrescr}"
                                                    size="55" value="#{servicioSurtPrescripcionExtMB.skuSap}" autocomplete="on" 
                                                    completeMethod="#{servicioSurtPrescripcionExtMB.autoComplete}" minQueryLength="4" forceSelection="true"
                                                    var="skuSap" itemValue="#{skuSap.idInventario}" itemLabel="#{skuSap.nombreLargo}"
                                                    converter="skuSapConverter"                                                     
                                                    tabindex="9"
                                                    placeholder="Escanear Código de Barras"
                                                    emptyMessage="Código de Barras desconocido." >
                                        <p:ajax event="itemSelect" 
                                                listener="#{servicioSurtPrescripcionExtMB.validaLecturaPorCodigo}" 
                                                update="codigSurt,tblInsumos,msgValidaRegistro,@this,xcantidad,txtEliminar,:formAlert" 
                                                oncomplete="if(!args.estatus){PF('modalAlertaAutorizacion').show();}else{ $('.focusme').focus()}" 
                                                process=":formSurtimientoDetail"></p:ajax>
                                        <p:ajax event="itemUnselect" 
                                                listener="#{servicioSurtPrescripcionExtMB.handleUnSelect}" 
                                                update="codigSurt,tblInsumos,msgValidaRegistro,xcantidad" 
                                                process=":formSurtimientoDetail"></p:ajax>
                                        
                                        <p:column style="width: 20px; font-size: small;" width="20px">
                                            <f:facet name="header" >
                                                <h:outputText value="Clave" />
                                            </f:facet>
                                            <h:outputText value="#{skuSap.claveInstitucional}" style=" font-size: small;" />
                                        </p:column>
                                        <p:column style="width: 20px; font-size: small;" width="20px">
                                            <f:facet name="header" >
                                                <h:outputText value="Clave Proveedor" />
                                            </f:facet>
                                            <h:outputText value="#{skuSap.claveProveedor}" style=" font-size: small; font-weight: bolder;" />
                                        </p:column>
                                        <p:column style="width: 20px; font-size: small;" width="20px">
                                            <f:facet name="header" >
                                                <h:outputText value="Lote" />
                                            </f:facet>
                                            <h:outputText value="#{skuSap.lote}" style=" font-size: small; font-weight: bolder;" />
                                        </p:column>
                                        <p:column style="width: 20px; font-size: small;" width="20px">
                                            <f:facet name="header" >
                                                <h:outputText value="Caducidad" />
                                            </f:facet>
                                            <h:outputText value="#{skuSap.fechaCaducidad}" style=" font-size: small; font-weight: bolder;" >
                                                <f:convertDateTime type="date" pattern="dd/MM/yyyy" />
                                            </h:outputText>
                                        </p:column>
                                        <p:column style="width: 350px; font-size: small;" width="350px">
                                            <f:facet name="header" >
                                                <h:outputText value="Descripción" />
                                            </f:facet>
                                            <h:outputText value="#{skuSap.nombreCorto}" style=" font-size: x-small;" />
                                        </p:column>
                                        <p:column style="width: 10px; font-size: small; align-content: center; " width="10px" >
                                            <f:facet name="header" >
                                                <h:outputText value="Existencia DU" />
                                            </f:facet>
                                            <h:outputText value="#{skuSap.cantidadActual}" style=" font-size: small; font-weight: bolder;" />
                                        </p:column>
                                        <p:column style="width: 10px; font-size: small; align-content: center; " width="10px" >
                                            <f:facet name="header" >
                                                <h:outputText value="Existencia Cajas" />
                                            </f:facet>
                                            <h:outputText value="#{skuSap.cantidadActual / skuSap.cantidadXCaja}" style=" font-size: small; font-weight: bolder;" />
                                        </p:column>
                                        <p:column style="width: 10px; font-size: small; align-content: center; " width="10px" >
                                            <f:facet name="header" >
                                                <h:outputText value="Presentación" />
                                            </f:facet>
                                            <h:outputText value="#{skuSap.presentacion}" style=" font-size: small; font-weight: bolder;" />
                                        </p:column>
                                    </p:autoComplete>
                                </div>
                                <div class="ui-g-12 ui-md-6 ui-lg-1">
                                    <p:inputText id="codigSurt" 
                                                 placeholder="" 
                                                 size="40" 
                                                 style="display: none;" 
                                                 value="#{servicioSurtPrescripcionExtMB.codigoBarras}" 
                                                 onkeypress="if (event.keyCode === 13) { agregaEnviado(); return false; } " >
                                    </p:inputText>
                                    <p:remoteCommand name="agregaEnviado"
                                                         actionListener="#{servicioSurtPrescripcionExtMB.validaLecturaPorCodigo}"
                                                         update="codigSurt,tblInsumos,msgValidaRegistro"
                                                         process="@form"
                                                         global="false" />
                                </div>
                            </div>
                        </div>

                        <p:dataTable id="tblInsumos" 
                                     widgetVar="tblInsumos" 
                                     value="#{servicioSurtPrescripcionExtMB.surtimientoInsumoExtendedList}"
                                     selection="#{servicioSurtPrescripcionExtMB.surtimientoInsumoExtendedSelected}"
                                     var="item" 
                                     rowKey="#{item.idSurtimientoInsumo}"
                                     rowIndexVar="row"
                                     selectionMode="single"
                                     style="margin-bottom:5px;"
                                     styleClass="mystyle"
                                     scrollable="true" scrollHeight="250"
                                     emptyMessage="No se encontraron Registros"
                                     reflow="true"
                                     paginatorTemplate="{Records} {CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {Exporters}"
                                     currentPageReportTemplate=" "
                                     paginator="true"
                                     rows="10"
                                     paginatorPosition="bottom"
                                     disabledTextSelection="false" 
                                     expandedRow="#{false}" 
                                     rendered="#{servicioSurtPrescripcionExtMB.sizeSurtimientoInsumoExtendedList gt -1}" >

                            <f:facet name="{Records}">
                                <div style="float:left;">
                                    <p:outputLabel class="footerLabel" value="  Medicamentos Recetados #{servicioSurtPrescripcionExtMB.sizeSurtimientoInsumoExtendedList}" rendered="true" />
                                </div>
                            </f:facet>

                            <p:column style="width:5%">
                                <p:rowToggler />
                            </p:column>
                            
                            <p:column style="text-align: left; width: 10% "
                                      sortBy="#{item.claveInstitucional}" >
                                <f:facet name="header" >
                                    <h:outputText value="Clave" />
                                </f:facet>
                                <h:outputText value="#{item.claveInstitucional}" />
                            </p:column>
                            <p:column style="text-align: left; width: 40% "
                                      sortBy="#{item.nombreCorto}" >
                                <f:facet name="header" >
                                    <h:outputText value="Nombre" />
                                </f:facet>
                                <h:outputText value="#{item.nombreCorto}" />
                            </p:column>
                            <p:column style="text-align: left; width: 10% " >
                                <f:facet name="header" >
                                    <h:outputText value="DU Solicitadas" title="Dósis Unitaria Solicitada" />
                                </f:facet>
                                <h:outputText value="#{item.cantidadSolicitada}" />
                            </p:column>
                            <p:column style="text-align: left; width: 10% " >
                                <f:facet name="header" >
                                    <h:outputText value="Cajas Solicitadas" />
                                </f:facet>
                                <h:outputText value="#{item.cajasSolicitadas}" />
                                 
                            </p:column>
                            
                            <p:column style="text-align: left; width: 10% " rendered="false" >
                                <f:facet name="header" >
                                    <h:outputText value="Lote Sugerido" />
                                </f:facet>
                                <h:outputText value="#{item.loteSugerido}" class="textoNegrita" />
                            </p:column>
                            <p:column style="text-align: left; width: 10% " >
                                <f:facet name="header" >
                                    <h:outputText value="DU Surtidas" />
                                </f:facet>
                                <h:outputText value="#{item.cantidadEnviada}" class="textoNegrita" />
                            </p:column>
                            <p:column style="text-align: left; width: 10% " >
                                <f:facet name="header" >
                                    <h:outputText value="Cajas Surtidas" />
                                </f:facet>
                                <h:outputText value="#{item.cajasSurtidas}" class="textoNegrita" />
                                 
                            </p:column>
                            <p:column style="text-align: left; width: 10% " rendered="#{servicioSurtPrescripcionExtMB.habilitaVales}">
                                <f:facet name="header" >
                                    <h:outputText value="No Cajas Vale" />
                                </f:facet>
                                <p:inputText id="canVale" value="#{item.cantidadVale}" size="6" onclick="this.select()">
                                    <p:ajax listener="#{servicioSurtPrescripcionExtMB.actualizaCantidadVale(item)}" update="canVale,formSurtimientoDetail:msgValidaRegistro,:formAlert" 
                                     oncomplete="if(!args.estatus){PF('modalAlertaAutorizacion').show();}else{ $('.focusme').focus()}" 
                                      process=":formSurtimientoDetail"/>
                                    <p:keyFilter regEx="#{servicioSurtPrescripcionExtMB.regexNumber}"  />
                                </p:inputText>
                            </p:column>
                            <ui:remove>
                            <p:column style="text-align: left; width: 15% " >
                                <f:facet name="header" >
                                    <h:outputText value="Justificante" />
                                </f:facet>
                                <p:selectOneButton value="#{item.idTipoJustificante}">
                                    <f:selectItems value="#{servicioSurtPrescripcionExtMB.justificacionList}" var="just" itemLabel="#{just.descripcion}" itemValue="#{just.idTipoJustificacion}" />
                                </p:selectOneButton>
                            </p:column>
                            </ui:remove>
                            <p:rowExpansion>
                                <p:dataTable var="enviado"
                                             value="#{item.surtimientoEnviadoExtendList}"
                                             scrollable="true" 
                                             emptyMessage="" >
                                    <p:column headerText="" style="width: 50%" />
                                    <p:column headerText="Clave Proveedor" style="width: 10%">
                                        <h:outputText value="#{enviado.claveProveedor}" />
                                    </p:column>
                                    
                                    <p:column headerText="Lote " style="width: 10%">
                                        <h:outputText value="#{enviado.lote}" />
                                    </p:column>
                                    
                                    <!--TODO:  SE ELIMINA PRESENCTACION DE CADUCIDAD SOLO PARA TOLUCA  -->
                                    <p:column headerText="Fecha de caducidad" style="width: 10%" rendered="true">
                                        <h:outputLabel value="#{enviado.caducidad}" >
                                            <f:convertDateTime type="date" pattern="dd/MM/yyyy" />
                                        </h:outputLabel>
                                    </p:column>
                                    <p:column headerText="Cantidad" style="width: 10%">
                                        <h:outputLabel value="#{enviado.cantidadEnviado}" />
                                    </p:column>
                                    <p:column headerText="Cantidad Cajas" style="width: 10%">
                                        <h:outputLabel value="#{enviado.cantidadEnviado / item.factorTransformacion}" />
                                    </p:column>
                                    <p:column headerText="" style="width: 20%" />
                                </p:dataTable>
                            </p:rowExpansion>

                        </p:dataTable>

                        <p:commandButton value="Surtir" 
                                         icon="fa fa-check-circle" style="margin-right: 10px;float: right;"
                                         rendered="#{servicioSurtPrescripcionExtMB.puedeSurtirPrescr}"
                                         disabled="#{!servicioSurtPrescripcionExtMB.procederSurtimiento}"                                         
                                         onclick="PF('statusProcess').show()"
                                         oncomplete="PF('statusProcess').hide();if(args.estatus){PF('mdlReport').show(); PF('modalSurtimiento').hide(); } "
                                         actionListener="#{servicioSurtPrescripcionExtMB.validaSurtimiento}" 
                                         update=":mainForm,:formSurtimientoDetail,:formPDF,:mainForm:validaMsg" >                             
                            <p:confirm header="Confirmación" message="Desea surtir la Receta ?" icon="ui-icon-alert" />                            
                        </p:commandButton>
<!--TODO: Limpia el mensaje de procesamiento-->
<!--
                    actualizaHeader();
                    <p:remoteCommand id="actualizaHeader"
                                         update=":mainForm:validaMsg"
                                         process="@form"
                                         global="false" />-->
                        
                        <p:commandButton value="Cancelar" 
                                         icon="fa fa-times-circle" 
                                         onclick="PF('modalSurtimiento').hide();"
                                         style="margin-right: 10px;float: right;" />
                        
                        <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                            <p:commandButton value="Si" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                            <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                        </p:confirmDialog>

                    </h:form>
                </p:dialog>
                
                <p:dialog widgetVar="mdlReport" width="820px" height="600px"  header="Surtimiento de Receta"
                          closeOnEscape="true" modal="true"                          
                          style="font-size:xx-small !important;" >
                    <h:form id="formPDF"   >                       
                        <p:media id="vpdf" value="#{servicioSurtPrescripcionExtMB.archivo}" player="pdf" width="800px" height="600px" cache="false"  class="vpdf"  />
                    </h:form>                    
                </p:dialog>
                
                    
                <p:dialog header="Surtimiento"
                          widgetVar="modalPrescripcion"
                          closeOnEscape="true"
                          closable="true"
                          modal="true" 
                          resizable="false"
                          responsive="true"
                          style="font-size:xx-small !important; " >

                    <h:form id="formPrescripcion" >

                        <p:focus context="formPrescripcion"/>

                        <p:messages id="msgValidaPrescripcion" globalOnly="false" showDetail="false" closable="true" />

                    </h:form>
                </p:dialog>

                <p:dialog header="Información de Registro"
                          widgetVar="modalEliminaDiagnosticoConfirm"
                          closeOnEscape="true"
                          closable="true"
                          modal="true" 
                          style="font-size:xx-small !important; " >

                </p:dialog>

                <p:dialog header="Información de Registro"
                          widgetVar="modalEliminaInsumoConfirm"
                          closeOnEscape="true"
                          closable="false"
                          modal="true" 
                          style="font-size:xx-small !important; " >

                </p:dialog>
                
                <p:dialog header="ALERTA" id="idAlert"
                          widgetVar="modalAlertaAutorizacion"
                          closeOnEscape="false"  resizable="false"
                          closable="false" styleClass="dlgAutoritation"
                          modal="true" style="align-content: center" >
                    <h:form id="formAlert">
                        <p:messages id="msgAuthorization" globalOnly="false" showDetail="false" closable="true" />
                        <div class="panelAlertYellow" style="height: 40px" align="center" >
                            <h:outputText value="#{servicioSurtPrescripcionExtMB.msjAlert}"  escape="false" />
                        </div>
                        <br/>
                        <div align="center">
                            <h:outputText value="RESPONSABLE"  class="textoNegrita" />
                        </div>                        
                        <div class="ui-g">
                            <div class="ui-g-12">
                                <div class="ui-g-12 ui-md-6 ui-lg-1">
                                    <p:outputLabel style="margin-right: 10px;" value="Nombre:" />
                                </div>
                                <div class="ui-g-12 ui-md-6 ui-lg-4" style="width: 470px !important;">
                                    <p:inputText  value="#{servicioSurtPrescripcionExtMB.nombreCompleto}"  size="55" readonly="true"   ></p:inputText>
                                </div>
                                <div class="ui-g-12 ui-md-6 ui-lg-1" style="width: 90px !important; border: #000 1 solid !important;">
                                    <p:commandButton value="Agregar" 
                                         styleClass="btnMusAzul"  rendered="false"
                                         icon="fa fa-plus"
                                         style="margin-right: 10px;float: right;" />
                                </div>
                                <div class="ui-g-12 ui-md-6 ui-lg-2" style="width: 90px !important;">
                                    <p:commandButton value="Editar" rendered="false" 
                                         styleClass="btnMusAzul" 
                                         icon="fa fa-pencil"                                          
                                         style="margin-right: 10px;float: right;" />
                                </div>
                            </div>
                        </div>  
                        <br/>
                        <div align="center">
                            <h:outputText value="AUTORIZADOR"  class="textoNegrita" />
                        </div>                        
                        <div class="ui-g">
                            <div class="ui-g-12">
                                <div class="ui-g-12 ui-md-8 ui-lg-1">
                                    <p:outputLabel style="margin-right: 10px;" value="Usuario:" />
                                </div>
                                <div class="ui-g-12 ui-md-8 ui-lg-3">
                                    <p:inputText value="#{servicioSurtPrescripcionExtMB.userResponsable}"  size="15"   > </p:inputText>
                                </div>
                                <div class="ui-g-12 ui-md-8 ui-lg-1" style="width: 80px !important;">
                                    <p:outputLabel style="margin-right:0px;" value="Contraseña:" />
                                </div>
                                <div class="ui-g-12 ui-md-8 ui-lg-4" style="width: 250px !important;">
                                    <p:inputText type="password"   value="#{servicioSurtPrescripcionExtMB.passResponsable}"  size="15"   > </p:inputText>
                                </div>
                                <div class="ui-g-12 ui-md-8 ui-lg-1">
                                    <p:commandButton value="Autorizar" 
                                        styleClass="btnMusVerde" 
                                        icon="fa fa-check" 
                                        onclick="PF('statusProcess').show()" 
                                        update=":formSurtimientoDetail:codigSurt,:formSurtimientoDetail:tblInsumos,:formSurtimientoDetail:msgValidaRegistro,:formSurtimientoDetail:xcantidad,:formAlert"
                                        actionListener="#{servicioSurtPrescripcionExtMB.Authorization}" oncomplete="if(args.estatus){PF('modalAlertaAutorizacion').hide();} PF('statusProcess').hide();"
                                        style="margin-right: 10px;float: right;" >
                                        <p:confirm header="Confirmación" message="¿Realmente desea autorizar el surtimiento ?" icon="ui-icon-alert" />
                                    </p:commandButton>
                                </div>
                            </div>
                        </div>  
                        <br/>
                        <p:commandButton value="Negar" rendered="false"
                                 styleClass="btnMusAzul" 
                                 icon="fa fa-check-circle"                        
                                 style="margin-right: 10px;float: right; width: 80px;"
                                onclick="PF('statusProcess').show()"
                                 />

                            <p:commandButton value="Cancelar"                                 
                                 icon="fa fa-times-circle"
                                 onclick="PF('statusProcess').show()"
                                 actionListener="#{servicioSurtPrescripcionExtMB.CancelAuthorization}"
                                 style="margin-right: 10px;float: right;" 
                                 oncomplete="PF('statusProcess').hide(); PF('modalAlertaAutorizacion').hide();"
                                 />  
                    </h:form>
                </p:dialog>

            </ui:define>
        </ui:composition>
    </h:body>
    
</html>

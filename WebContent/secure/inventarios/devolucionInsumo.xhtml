<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd" > 
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"    
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui" >
          <style type="text/css">
              .autoCMedicamento{
                  margin-right: 10px;
              }
          </style>
  
    <h:body>
        <ui:composition template="../template/mainLayout.xhtml">
            <ui:define name="content">
                <div class="mainPanel" style="padding: 10px;">
                    <p:ajaxStatus onstart="PF('statusDialog').show()" onsuccess="PF('statusDialog').hide()" />
                    <p:dialog widgetVar="statusDialog" modal="true" draggable="false" closable="false" resizable="false" showHeader="false">
                        <p:graphicImage name="/img/cargando.gif" />
                    </p:dialog>
                    <h:form id="formDevolucionReabasto">
                        <p:messages id="msg" globalOnly="true" closable="true" showDetail="false"/>
                        <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                            <p:commandButton value="Si" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                            <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                        </p:confirmDialog>

                        <div style="background: #808080;padding: 10px;">
                            <p:outputLabel value="Devolución Insumos" 
                                           style="color: #FFFFFF;font-size: 18px !important;font-weight: bold;margin-right: 20px;"/>
                            <p:commandButton id="btnCrear" value="Crear Devolución"
                                             title="Crear Nueva Orden de Devolución"
                                             icon="ui-icon-document"
                                             oncomplete="PF('modalDevolucion').show();"
                                             update="@form formDetalleDevolucion"
                                             actionListener="#{devolucionInsumoMB.crearOrdenDevolucion}"
                                             disabled="#{!devolucionInsumoMB.permiso.puedeCrear}" />
                            <ui:remove>
                            <p:outputLabel value="Almacen" 
                                           style="margin-right: 10px;margin-left: 10px;color: #FFF;font-size: 14px;font-weight: bold;"/>
                            <p:selectOneMenu id="comboAlmacen" 
                                             value="#{devolucionInsumoMB.idEstructura}"
                                             disabled="#{!devolucionInsumoMB.permiso.puedeVer}"
                                             style="vertical-align: middle;">
                                <p:ajax listener="#{devolucionInsumoMB.obtenerOrdenesDevolucion}" 
                                         update="tablaDevolucionReabasto" />             
                                <f:selectItems value="#{devolucionInsumoMB.listaEstructuras}"
                                               var="estructura"
                                               itemValue="#{estructura.idEstructura}"
                                               itemLabel="#{estructura.nombre}"/>
                            </p:selectOneMenu>
                            </ui:remove>
                            <p:inputText id="busqueda" 
                                         value="#{devolucionInsumoMB.textoBusqueda}" 
                                         style="width: 35%!important;border-radius:10px!important;margin-left: 30px;" 
                                         placeholder="Buscar por folio, Nombre del solicitante..." />
                            <i class="iconSearch" >
                                <img src="../../resources/img/Medicamento/search-lupa.png" title="Presiona para buscar" alt="15" style=""/>
                            </i>
                            <p:commandButton value="Buscar" 
                                             actionListener="#{devolucionInsumoMB.buscarDevolucion}"
                                             update="tablaDevolucionReabasto, formDetalleDevolucion"
                                             icon="fa fa-search" 
                                             style="margin-left: 20px;"
                                             oncomplete="if(args.estatusModal){ PF('modalDevolucion').show(); }">
                            </p:commandButton>
                        </div>
                        
                        <p:dataTable id="tablaDevolucionReabasto"
                                     var="devolucionReabasto"
                                     value="#{devolucionInsumoMB.listDevolucion}"
                                     style="text-align: center;"
                                     emptyMessage="No existen registros para mostrar."
                                     selectionMode="single"
                                     scrollable="true" 
                                     scrollHeight="350"
                                     selection="#{devolucionInsumoMB.devolucionSelect}"
                                     rowKey="#{devolucionReabasto.idDevolucion}">

                            <p:ajax event="rowDblselect" oncomplete="PF('modalDevolucion').show();" 
                                    update="formDetalleDevolucion" 
                                    listener="#{devolucionInsumoMB.mostrarModalDevolucion}"/>

                            <p:column headerText="Folio">
                                <h:outputText value="#{devolucionReabasto.folio}" />
                            </p:column>
                            <p:column headerText="Fecha">
                                <h:outputLabel value="#{devolucionReabasto.fechaDevolucion}">
                                    <f:convertDateTime type="date" pattern="dd/MM/yyyy" />
                                </h:outputLabel>
                            </p:column>
                            <p:column headerText="Almacén Origen">
                                <h:outputText value="#{devolucionReabasto.nombreOrigen}" />
                            </p:column>
                            <p:column headerText="Almacén Destino">
                                <p:outputLabel value="#{devolucionReabasto.nombreDestino}" />
                            </p:column>
                            <p:column headerText="Estatus">
                                <p:outputLabel value="#{devolucionReabasto.nombreEstatus}" />
                            </p:column>
                            <f:facet name="footer">
                                <p:outputLabel> </p:outputLabel>
                            </f:facet>
                        </p:dataTable>
                    </h:form>

                    <p:dialog header="Devolución de Insumos Por Servicio" 
                              widgetVar="modalDevolucion"
                              modal="true"
                              closeOnEscape="true"
                              resizable="false"
                              width="90%">
                        <h:form id="formDetalleDevolucion">
                            <p:messages id="msgModal" closable="true" showDetail="false"/>
                            <div class="ui-g panelGris" >
                            	<div class="ui-g-12" >
                                    <div class="ui-g-12 ui-md-6 ui-lg-2">
                                        <p:outputLabel style="margin-right: 10px;" value="Almacén / Servicio Origen:" />
                                        <br/>
                                        <ui:remove><h:outputText style="margin-right: 10px;" class="textoNegrita" value="#{devolucionInsumoMB.almacenOrigen}" /></ui:remove>
                                        <p:selectOneMenu id="comboAlmacenOrigen" 
                                                         value="#{devolucionInsumoMB.idEstructuraOrigen}"
                                             disabled="#{!devolucionInsumoMB.permiso.puedeVer}"
                                             style="vertical-align: middle;">
                                            <p:ajax update=":formDetalleDevolucion:comboAlmacenDestino" listener="#{devolucionInsumoMB.obtenerDestinoByOrigen()}" />
                                            <f:selectItems value="#{devolucionInsumoMB.listaEstructurasOrigen}"
                                                           var="estructura"
                                                           itemValue="#{estructura.idEstructura}"
                                                           itemLabel="#{estructura.nombre}"/>
                                        </p:selectOneMenu>
                                    </div>
                                    <div class="ui-g-12 ui-md-6 ui-lg-2">
                                        <p:outputLabel style="margin-right: 10px;" value="Almacén Destino:" />
                                        <br/>
                                        <ui:remove><h:outputText style="margin-right: 10px;" class="textoNegrita" value="#{devolucionInsumoMB.almacenDestino}" /></ui:remove>
                                        <p:selectOneMenu id="comboAlmacenDestino" 
                                                         value="#{devolucionInsumoMB.idEstructuraDestino}"
                                             disabled="#{!devolucionInsumoMB.permiso.puedeVer}"
                                             style="vertical-align: middle;">                                            
                                            <f:selectItems value="#{devolucionInsumoMB.listaEstructuras}"
                                                           var="estructura"
                                                           itemValue="#{estructura.idEstructura}"
                                                           itemLabel="#{estructura.nombre}"/>
                                        </p:selectOneMenu>
                                    </div>
                                    <div class="ui-g-12 ui-md-4 ui-lg-1"  >
                                        <p:outputLabel style="margin-right: 10px;margin-left: 20px;">Borrar</p:outputLabel>
                                        <br />
                                        <p:selectBooleanCheckbox style="margin-right: 10px;;margin-left: 20px;" 
                                                                 value="#{devolucionInsumoMB.eliminarCodigo}" 
                                                                 id="checkEliminar"
                                                                 disabled="#{devolucionInsumoMB.devolucionSelect.idEstatusDevolucion eq 1 ? true : false}"/>
                                    </div>	
                                    <div class="ui-g-12 ui-md-4 ui-lg-1" >
                                        <p:outputLabel value="Cantidad: " />
                                        <br/>
                                        <p:inputText id="xCantidad" style="width: 98%;" 
                                                     value="#{devolucionInsumoMB.xCantidad}"
                                                     onkeypress="if (event.keyCode === 13) { return false; }"                               	    			 
                                                     maxlength="5"
                                                     disabled="#{devolucionInsumoMB.devolucionSelect.idEstatusDevolucion eq 1 ? true : false}">
                                            <p:keyFilter regEx="/[0-9]/i"/>
                                        </p:inputText>
                                    </div>

                                    <div class="ui-g-12 ui-md-4 ui-lg-2"  >
                                        <p:outputLabel value="Motivo" />
                                        <br/>
                                        <p:selectOneMenu id="comboTipoMotivo" 
                                                         value="#{devolucionInsumoMB.idTipoMotivo}"
                                                         disabled="#{!devolucionInsumoMB.permiso.puedeVer}"
                                                         style="vertical-align: middle; ">
                                            <f:selectItems value="#{devolucionInsumoMB.listTipoMotivos}"
                                                           var="tipoMotivo"
                                                           itemValue="#{tipoMotivo.idTipoMotivo}"
                                                           itemLabel="#{tipoMotivo.descripcion}"/>
                                        </p:selectOneMenu>
                                    </div>

                                    <div id="panelAutoComplete" class="ui-g-12 ui-md-4 ui-lg-4" >                                        
                                        <p:outputLabel value="Insumo: " />
                                        <br/>
                                        <p:inputText id="codMed" value="#{devolucionInsumoMB.codigoBarras}" rendered="#{!devolucionInsumoMB.devoSinPistoleo}" 
                                                     onkeypress="if (event.keyCode === 13) { ingresarCodigo(); return false; }" 
                                                     style="width: 98%" 
                                                     disabled="#{devolucionInsumoMB.devolucionSelect.idEstatusDevolucion eq 1 ? true : false}">
                                            <p:remoteCommand name="ingresarCodigo"
                                                             actionListener="#{devolucionInsumoMB.agregarDevolucionPorCodigo}"
                                                             update="codMed,tablaDetalleDev,msgModal,xCantidad,checkEliminar"
                                                             process="@form"
                                                             global="false"
                                                             />
                                        </p:inputText>
                                        <p:autoComplete id="autoCMedicamento"
                                                        value="#{devolucionInsumoMB.rptInventarioExis}" 
                                                        rendered="#{devolucionInsumoMB.devoSinPistoleo}"
                                                        autocomplete="on" 
                                                        completeMethod="#{devolucionInsumoMB.autocompleteMedicamento}" 
                                                        minQueryLength="4"  
                                                        size="30"
                                                        var="skuSap"
                                                        itemValue="#{skuSap.idInventario}" 
                                                        itemLabel="#{skuSap.nombreMedicamento}"
                                                        converter="rptInventarioConverter" tabindex="5"                                                 
                                                        placeholder="Escanear Medicamento"
                                                        emptyMessage="Código de Barras desconocido."                                                          
                                                        scrollHeight="250"   >
                                            <p:ajax event="change"  update="formDetalleDevolucion:autoCMedicamento" />
                                            <p:ajax event="itemSelect" update="formDetalleDevolucion:autoCMedicamento,tablaDetalleDev,msgModal,xCantidad,checkEliminar" 
                                                    listener="#{devolucionInsumoMB.handleSelectMedicamento}" process="@form" ></p:ajax>
                                            <p:ajax event="itemUnselect" listener="#{devolucionInsumoMB.handleUnSelectMedicamento}" ></p:ajax>

                                            <p:column style="width: 20px; font-size: small !important;" width="20px">
                                                <f:facet name="header" >
                                                    <h:outputText value="Clave"  />
                                                </f:facet>
                                                <h:outputText value="#{skuSap.claveMedicamento}" style=" font-size: small; font-weight: bolder;" />
                                            </p:column>                                            
                                            <p:column style="width: 350px; font-size: small !important;" width="350px">
                                                <f:facet name="header" >
                                                    <h:outputText value="Descripción" />
                                                </f:facet>
                                                <h:outputText value="#{skuSap.nombreMedicamento}" style=" font-size: x-small;" />
                                            </p:column>                                            
                                            <p:column style="width: 20px; font-size: small !important; " >
                                                <f:facet name="header" >
                                                    <h:outputText value="Lote" />
                                                </f:facet>
                                                <h:outputText value="#{skuSap.lote}" style=" font-size: small; font-weight: bolder;" />
                                            </p:column>
                                            <p:column style="width: 20px; font-size: small !important; " >
                                                <f:facet name="header" >
                                                    <h:outputText value="Caducidad" />
                                                </f:facet>
                                                <h:outputText value="#{skuSap.fechaCaducidad}" style=" font-size: small; font-weight: bolder;" >
                                                    <f:convertDateTime type="date" pattern="dd/MM/yyyy" />
                                                </h:outputText>
                                            </p:column>
                                            <ui:remove><p:column style="width: 15px; font-size: small !important; " >
                                                <f:facet name="header" >
                                                    <h:outputText value="Existencia&nbsp;DU" />
                                                </f:facet>
                                                <h:outputText value="#{skuSap.cantidadActual}" style=" font-size: small; font-weight: bolder;" />
                                            </p:column></ui:remove>                                 
                                        </p:autoComplete>
                                    </div>

                                    <div>
                                		<p:commandButton value="Agregar Motivo"
                                			 actionListener="#{devolucionInsumoMB.asignarMotivoDevolucion}"
                                			 onclick="PF('statusProcess').show();"
                                			 update="tablaDetalleDev, msgModal"
                                			 oncomplete="PF('statusProcess').hide();" 
                                             icon="fa fa-check-circle"  
                                             style="margin-right: 10px;float: right;"
                                             rendered="#{devolucionInsumoMB.devolucionSelect.idEstatusDevolucion eq 1 ? true : false}"/>                                		
                                	</div>
                                </div>
                            </div>   
                            <p:dataTable id="tablaDetalleDev"
                                         var="insumo"
                                         value="#{devolucionInsumoMB.listDevolucionDetalle}"
                                         scrollable="true" 
                                         scrollHeight="350"
                                         emptyMessage="No se encontraron Registros">
                                <p:column headerText="Clave" style="width:10%">
                                    <h:outputText value="#{insumo.claveInstitucional}" />
                                </p:column>
                                <p:column headerText="Descripción" style="width:30%">
                                    <h:outputLabel value="#{insumo.nombreCorto}" />
                                </p:column>
                                <p:column headerText="Presentación"  style="width:10%" rendered="false">
                                    <h:outputText value="#{insumo.nombrePresentacion}" />
                                </p:column>
                                <p:column headerText="Pieza x caja" style="width:10%" rendered="false">
                                    <p:outputLabel value="#{insumo.factorTransformacion}" />
                                </p:column>
                                <p:column headerText="Lote" style="width:10%">
                                    <p:outputLabel value="#{insumo.lote}" />
                                </p:column>
                                <p:column headerText="Caducidad" style="width:10%">
                                    <p:outputLabel value="#{insumo.fechaCaducidad}" >
                                        <f:convertDateTime type="date" pattern="dd/MM/yyyy" />
                                    </p:outputLabel>
                                </p:column>
                                <p:column headerText="Cant. Devolver" style="width:10%">
                                    <p:outputLabel value="#{insumo.cantidad}" />
                                </p:column>
                                <p:column headerText="Motivo" style="width:10%">
                                	<p:outputLabel value="#{insumo.nombreMotivo}" />
                                </p:column>
                                <p:column headerText="Comentarios" style="width:10%">
                                    <p:inputText    value="#{insumo.comentario}" 
                                                    style="width: 100%" />
                                </p:column>
                                <f:facet name="footer">
                                    <p:outputLabel> </p:outputLabel>
                                </f:facet>
                            </p:dataTable>
                            <br/>
                            <p:commandButton value="Cacelar" 
                                             icon="fa fa-times-circle" 
                                             style="margin-right: 10px;float: right;"
                                             oncomplete="PF('modalDevolucion').hide();"
                                             />
                            <p:commandButton value="Devolver" 
                                             actionListener="#{devolucionInsumoMB.registrarDevolucion}"
                                             onclick="PF('statusProcess').show();"
                                             update="formDevolucionReabasto,formDetalleDevolucion"
                                             oncomplete="if (args.status) { PF('modalDevolucion').hide(); } PF('statusProcess').hide(); "
                                             icon="fa fa-check-circle" 
                                             style="margin-right: 10px;float: right;"
                                             disabled="#{!devolucionInsumoMB.permiso.puedeProcesar}"
                                             rendered="#{devolucionInsumoMB.crearDevolucion}"
                                             > 
                                <p:confirm header="Confirmación" message="Desea devolver los Insumos ?" icon="ui-icon-alert" />
                            </p:commandButton>
                            <ui:remove><p:commandButton value="Devolver" 
                                             actionListener="#{devolucionInsumoMB.actualizarDevolucion}"
                                             onclick="PF('statusProcess').show();"
                                             update="formDevolucionReabasto,formDetalleDevolucion"
                                             oncomplete="if (args.status) { PF('modalDevolucion').hide(); } PF('statusProcess').hide(); "
                                             icon="fa fa-check-circle" 
                                             style="margin-right: 10px;float: right;"
                                             disabled="#{!devolucionInsumoMB.permiso.puedeProcesar}"
                                             rendered="#{devolucionInsumoMB.devolucionCreada}"
                                             > 
                                <p:confirm header="Confirmación" message="Desea devolver los medicamentos ?" icon="ui-icon-alert" />
                            </p:commandButton>
                             <p:commandButton value="Guardar" 
                                              accesskey="" icon="fa fa-floppy-o" 
                                              style="margin-right: 10px;float: right;"
                                              actionListener="#{devolucionInsumoMB.guardarRegistros}"
                                              update="msgModal"
                                             /></ui:remove>
                        </h:form>
                    </p:dialog>
                </div>
            </ui:define>

            <ui:define name="footer">
            </ui:define>
        </ui:composition>
    </h:body>
</html>
